# =============================================================================
# FOODKEYS WEBLOG - PRODUCTION DOCKER COMPOSE
# Enhanced configuration for production deployments with:
# - Resource limits
# - Health checks
# - Logging configuration
# - Security settings
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Next.js Application
  # ---------------------------------------------------------------------------
  app:
    image: next-weblog:v0.4
    container_name: foodkeys-weblog
    restart: always
    environment:
      NODE_ENV: production
      DATABASE_URL: postgresql://postgres:gZspMkBe8z@postgres:5432/fk?schema=news
      API_KEY: 9b2c69f62faa8890d2815968586d6c7473c244aad095243b38b6a41e2da0f9a4
      TOTP_SECRET: JJBSWY3DPEHPK3PXPJBSWY3DPEHPK3PXP
      NEXT_PUBLIC_SITE_URL: https://news.agfo.ir
      NEXT_PUBLIC_SITE_NAME: نشریه فودکیز
      NEXT_PUBLIC_SITE_DESCRIPTION: پلتفرم خبر و مقاله
    volumes:
      - ./uploads_data:/app/public/uploads
    ports:
      - "3300:3300"
    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:3000/",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: "2"
          memory: 1G
        reservations:
          cpus: "0.25"
          memory: 256M
    networks:
      - foodkeys-network
    # Security settings
    security_opt:
      - no-new-privileges:true
    read_only: false
    tmpfs:
      - /tmp

# =============================================================================
# Volumes
# =============================================================================
volumes:
  uploads_data:
    driver: local

# =============================================================================
# Networks
# =============================================================================
networks:
  foodkeys-network:
    external: true
